# Khaki

> Unlock your car using your phone

## What We Have

- Raspberry Pi model B
- Bluetooth 4.0 USB adapter
- A spare key fob that can unlock your car
- An iPhone

## The Setup

We have a Raspbery Pi with Arch Linux for ARM installed on it.
On top of that we have the bluez libraries installed as well as the Go
compiler.

The Pi will be connected to the spare key fob, specifically the buttons that 
lock and unlock the car.

We will be using the github.com/paypal/gatt library to setup a BLE peripheral
that can be connected to from a phone.

## Security

Uses a challenge-response system with a shared key encryption.

Start the peripheral server with a secret key, that only you know.

    ./khaki --secret=hunter2

When the phone connects, it immediately starts the authentication process. If
authentication isn't successful within 5 seconds, the Pi will close the
connection.

    S = Server/Central (Pi)
    C = Client/Peripheral (iPhone)

    // Client request challenge code
    C -> READ auth

    // Server generates random bytes for challenge
    S -> [3e 48 5a 8d fb 30 0d 54 71 6e a6 68 18 72 b0 34]

    // Client calculates HMAC of bytes, and sends it to to the server
    C -> WRITE auth [88 62 38 70 73 03 ea d9 92 d6 e4 96 29 03 a2 90 e6 f2 2c 9e 3d d8 90 9c f5 e6 c7 02 58 98 41 b9]

    // Server validates the HMAC and responds with status
    S -> [01]

The challenge code is hashed using HMAC with SHA256.

    h := hmac.New(sha256.New, secretKey)
    h.Write(challengeCode)
    result := h.Sum(nil)

This authentication process is only needed when the client first connects to
the server. From then on the connection is marked as authenticated, and the
client to unlock/lock the car.

requests the Pi to unlock the car. The Pi responds
with a challenge code (randomly generated bytes). The phone computes the
HMACSHA256 of the challenge and sends it back to the Pi. The Pi verifies that
the hash matches, and if so gives the ...

But how to handle sessions? Possible that the Pi gets confused about who is
currently connected and if they have authentication.

Maybe you have to authenticate every request, by passing a HMAC of something.
Maybe the characteristic UUID? But you don't want to be sending the same data
every time, because then people can steal it.

But unlocking isn't something you do that often, maybe a couple times a minute
at most, so it doesn't matter if it's a bit more complicated and takes a few
transactions.

Maybe keep a log of requests.

Maybe lock it by MAC address? Probably not, as I think BLE 4.0 randomises MACs
every 15 minutes. Need to check this.

## Services & Characteristics

Very simple interface, with just one service with two characteristics.

- Car (uuid: ----)
    - Lock (uuid: ----)
    - Unlock (uuid: ----)

**Secure Service**

Kind of like oauth?

Only need to do it once.

- Auth
    - RequestCode
    - ConfirmCode
